<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muro Social - ChefConnect</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Estilos espec√≠ficos para el muro */
        .nav-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .nav-bar a {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
        }

        /* Estilo del Widget de API Externa */
        .api-widget {
            background: #e3f2fd;
            border: 2px dashed #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
        }

        .api-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
            text-align: left;
        }

        .api-content img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
        }

        /* Estilo de Tarjetas del Muro */
        .social-card {
            background: white;
            border: 1px solid #ddd;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .social-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .social-body {
            padding: 15px;
        }

        .author-tag {
            background: #eee;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
    </style>
</head>

<body>
    <div class="app-layout">
        <aside class="sidebar">
            <h2>üë®‚Äçüç≥ ChefConnect</h2>
            <ul class="nav-links">
                <li>
                    <a href="social.html" id="link-social">üåé Muro Global</a>
                </li>
                <li>
                    <a href="favorites.html" id="link-favorites">üë®‚Äçüç≥ Chefs Favoritos</a>
                </li>
                <li>
                    <a href="dashboard.html" id="link-dashboard">üìñ Mis Recetas</a>
                </li>
            </ul>
            <div class="logout-container">
                <button id="btn-logout-social" class="btn-logout-sidebar">Cerrar Sesi√≥n</button>
            </div>
        </aside>

        <main class="main-content">
            <h1>Qu√© est√° cocinando el mundo</h1>

            <div class="api-widget">
                <h3>¬øSin inspiraci√≥n? üí°</h3>
                <p>Sugerencia de <span style="font-weight: bold;">TheMealDB API</span>:</p>

                <div id="api-loading">Buscando idea...</div>

                <div id="api-result" class="api-content" style="display: none;">
                    <img id="api-img" src="" alt="Comida Random">
                    <div>
                        <h4 id="api-title" style="margin: 0;">Titulo</h4>
                        <small id="api-cat">Categor√≠a</small>
                    </div>
                </div>

                <button id="btn-nueva-idea" style="margin-top: 10px;">Otra idea</button>
            </div>

            <hr>
            <div id="feed-social">
                <p>Cargando recetas...</p>
            </div>
        </main>
    </div>

    <script type="module">
        import { cerrarSesion, observarEstado } from "./src/auth.js";
        import { obtenerRecetasPublicas } from "./src/recipes.js";
        import { obtenerIdeaAleatoria } from "./src/api-externa.js";

        import { seguirUsuario, dejarDeSeguir, estoySiguiendoA } from "./src/social-ops.js";

        let usuarioActual = null;
        // 1. Seguridad b√°sica
        observarEstado((user) => {
            if (!user) window.location.href = "index.html";
            usuarioActual = user;
            cargarfeed();
        });

        document.getElementById('btn-logout-social').addEventListener('click', cerrarSesion);

        // 2. Cargar Widget de API Externa
        const cargarWidget = async () => {
            const loading = document.getElementById('api-loading');
            const result = document.getElementById('api-result');

            loading.style.display = 'block';
            result.style.display = 'none';

            const idea = await obtenerIdeaAleatoria();

            if (idea) {
                document.getElementById('api-title').textContent = idea.titulo;
                document.getElementById('api-cat').textContent = `${idea.area} - ${idea.categoria}`;
                document.getElementById('api-img').src = idea.imagen;

                loading.style.display = 'none';
                result.style.display = 'flex';
            } else {
                loading.textContent = "Error al cargar API";
            }
        };

        // Evento para el bot√≥n "Otra idea"
        document.getElementById('btn-nueva-idea').addEventListener('click', cargarWidget);
        // Cargar al inicio
        cargarWidget();

        // 3. Cargar Feed Social (Firestore)
        const cargarFeed = async () => {
            const container = document.getElementById('feed-social');
            container.innerHTML = "<p>Cargando recetas...</p>";
            const recetas = await obtenerRecetasPublicas();

            container.innerHTML = "";

            // Usamos un bucle for...of para poder usar await dentro
            for (const receta of recetas) {
                const card = document.createElement('div');
                card.className = "social-card";

                // Verificamos si ya sigo a este chef
                const yaLoSigo = await estoySiguiendoA(usuarioActual.uid, receta.user_id);
                const esMiReceta = (usuarioActual.uid === receta.user_id);

                // Definimos el bot√≥n (Seguir o Dejar de seguir)
                let botonHTML = "";
                if (!esMiReceta) {
                    botonHTML = yaLoSigo
                        ? `<button class="btn-follow following" data-author="${receta.user_id}">Dejar de seguir</button>`
                        : `<button class="btn-follow" data-author="${receta.user_id}">Seguir</button>`;
                }

                const imgUrl = receta.imagen_url || "https://via.placeholder.com/400x200";

                // ... (Aqu√≠ va tu l√≥gica de ingredientes vs instrucciones que hicimos antes) ...
                const contenido = receta.instrucciones
                    ? `<p>${receta.instrucciones}</p>`
                    : `<p><strong>ü•ï Ingredientes:</strong><br>${receta.ingredientes}</p>
                    <p><strong>üìù Pasos:</strong><br>${receta.pasos}</p>`;

                card.innerHTML = `
                    <img src="${imgUrl}" class="social-img" alt="${receta.titulo}">
                    <div class="social-body">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 style="margin:0;">${receta.titulo}</h3>
                            ${botonHTML}
                        </div>
                        <div style="color: #444; font-size: 0.95em; margin-top: 10px;">
                            ${contenido}
                        </div>
                        <div style="margin-top: 15px;">
                            <span class="author-tag">üë§ Chef: ${receta.autor || "An√≥nimo"}</span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            }

            // ACTIVAR LOS BOTONES DE SEGUIR
            document.querySelectorAll('.btn-follow').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const idAutor = e.target.dataset.author;
                    const esFollowing = e.target.classList.contains('following');

                    if (esFollowing) {
                        await dejarDeSeguir(usuarioActual.uid, idAutor);
                        e.target.textContent = "Seguir";
                        e.target.classList.remove('following');
                    } else {
                        await seguirUsuario(usuarioActual.uid, idAutor);
                        e.target.textContent = "Siguiendo ‚úÖ";
                        e.target.classList.add('following');
                    }
                });
            });
        };

        cargarFeed();

    </script>
</body>

</html>